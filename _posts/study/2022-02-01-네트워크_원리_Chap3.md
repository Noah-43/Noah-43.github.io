---
title: 네트워크_원리_Chap3
excerpt: 성공과 실패를 결정하는 1%의 네트워크 원리 책 3장 정리
categories: study
---
# Chapter 3

## 케이블과 리피터, 허브 속을 신호가 흘러간다
### 하나하나의 패킷이 독립된 것으로 동작한다
- 패킷을 중계할 때는 패킷의 헤더에 기록된 제어 정보와 중계 장치 내부에 있는 중계 대상을 등록한 표로 목적지를 판단한다.
- 패킷 운반할 때는 패킷의 내용을 보지 않아 애플리케이션 데이터, TCP 프로토콜의 제어 정보등은 패킷 운반에 영향을 주지 않는다. (HTTP 메시지, TCP 수신 확인, 시퀀스 번호 등의 정보 모두 무시)
- 모든 패킷은 아무 관련도 없는 별개의 것으로 간주되어 목적지를 향해 중계된다.

### LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다
- LAN 어댑터의 PHY 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블를 통과해 리피터 허브의 커넥터 부분에 도착한다. (단순 전기 신호 전달)
- 이 과정에서 신호의 에너지가 조금씩 떨어지고 이는 케이블의 길이가 길고, 주파수가 높을수롤 신호가 약해진다.
- 여기에 잡음의 영향까지 더해시면 심각하게 변형되고 양해진 신호가 더욱 변형되어 0과 1을 잘못 판독해 통신 오류의 원인이 되기도 한다.

### '꼼'은 잡음을 방지하기 위한 방법이다
- LAN 케이블로 사용하는 트위스트 페어 케이블은 두 가닥의 신호선을 한 조로 마주 꼬은 선인데, 이를 이용해 잡음을 막을 수 있다.
- 잠음의 원인은 케이블 주위에서 발생하는 전자파이다. 영향을 주는 전자파는 두 종류로 나눌 수 있고, '꼼'을 통해 영향을 줄일 수 있다.
  - 케이블 밖에서 누설되는 전자파 (모니터, 형광등, CRT 모니터와 같은 기기에서 누설)
  - 케이블 안의 인접한 신호선에서 누설되는 전자파 (크로스토크)
- 신호선을 꼬아서 잡음의 영향이 줄어 케이블 성능이 향상되지만 성능 향상 대책은 더 있다.
  -  신호선 사이의 거리를 유지하기 위해 신호선 사이에 구분판 넣기
  -  전자파 차단을 위해 금속성의 실드(차폐)라는 피복 입히기
-  그 결과, 성능이 다른 몇 종류의 케이블이 있으며, 카테고리라는 척도로 성능을 나타낸다.

### 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다
- 수신측에서는 송신측처럼 RJ-45커넥터에 직접 접속하는 것이 아니라, MDI/MDI-X와 같은 전환 스위치를 사용하거나, 크로스 케이블로 접속한다. ('송신 단자'에서 보낸 신호를 '수신 단자'로 받음)
- 리피터 허브에서 PHY 회로의 수신부에 도달한 신호는 리피터 회로에 들어가 모든 커넥터에서 나가면서 리피터 허브에 접속한 전체 기기에 도달한다.(기본적으로 들어온 신호를 그대로 송출)
- 신호를 수신한 기기는 MAC 헤더의 수신처 MAC 주소를 조사해 수신하거나, 무시한다.
- 리피터 회로의 기본은 신호를 그대로 뿌리는 것이기에 잡음의 영향을 받아 변형되고, 데이터가 변화한 것 같은 신호라도 그대로 흘리는데, 이 경우 스위칭 허브, 라우터, 서버 등에 도달하여 디지털 데이터로 변환되고, FCS를 검사하는 곳에서 데이터 변화가 판명된 후 변화된 패킷은 폐기된다.
- 패킷을 폐기하면 수신 확인 응답을 되돌려주지 않아 TCP 담당 부분이 패킷을 다시 보낸다.

## 스위칭 허브의 패킷 중계 동작
### 스위칭 허브는 주소 테이블로 중계한다
- 스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있다.
- 신호가 커넥터 부분에 도달하여 PHY 회로에서 수신되는 부분까지는 리피터 허브와 같다.
- PHY 회로의 수신 부분에 들어온 후의 동작은 LAN 어댑터와 거의 같다. 각 스위칭 허브의 커넥터 안쪽에는 LAN 어댑터와 같은 회로가 있다고 생각하자.
- 커넥터와 안쪽에 있는 회로 부분을 포트라 부르므로 스위칭 허브의 각 포트는 PC의 LAN 어댑터와 거의 같지만, 수신처 MAC 주소를 검사하지 않고 모든 패킷을 수신하여 버퍼 메모리에 저장하기 때문에 스위칭 허브의 포트에서는 MAC 주소가 할당되어 있지 않다.

**스위치 회로**
- 전자 회로로 만든 것, 입력 포트와 출력 포트를 연결 할 수 있다.
- 신호선이 격자 모양으로 배치되고, 교점에 스위치가 있어 전자적으로 개폐를 제어할 수 있고, 이 전자적 개폐를 통해 신호가 흐르는 대상을 제어한다.
- 신호의 교점에 있는 스위치는 각각 독립하여 움직이므로 신호가 중복되지 않으면 복수의 신호를 동시에 흘릴 수도 있다.

### MAC 주소 테이블을 등록 및 갱신한다
- 스위칭 허브는 패킷을 수신했을 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록한다.
- 사용하지 않고 일정 시간이 경과하면 등록 정보를 삭제한다.
- 이렇게 MAC 주소표의 내용은 스위칭 허브 자체가 스스로 등록하거나 삭제하므로 등록 및 삭제할 필요하 없다.
- MAC 주소표의 내용이 이상해진 경우에도 기기를 리셋해버리면 이후로 새롭게 주소가 등록되므로 수동 갱신할 필요가 없다.

### 예외적인 동작
- 스위칭 허브는 수신한 포트에는 송신하지 않는다.(ex. 리피터 허브에서 수신한 경우, 송신 시 두 개의 같은 패킷이 다른 곳에 도착하는 문제 발생)
- MAC 주소표에 수신처 MAC 주소와 일치하는 주소가 등록되어 있지 않은 경우 수신 포트 이외의 전체 포트에 패킷을 송신한다.

### 전이중 모드에서 송신과 수신을 동시에 실행한다
- 전이중 모드, 즉 송신과 수신을 동시에 실행할 수 있는 성질도 리피터 허브에는 없는 스위칭 허브의 특징이다.
- 이더넷에서 송신과 수신을 동시에 실행할 수 없는데, 규칙을 개정하여 신호가 흐르고 있어도 상관하지 않고 송신할 수 있는 동작 모드가 추가되었다. 동시에 이 동작 모드로 동작할 때는 신호의 충돌을 검출하는 회로를 무효화하기로 했는데, 이것이 '전이중'이라는 동작 모드이다.

### 최적의 전송 속도로 보내는 자동 조정
- 전이중 모드의 등장에 따라, 전이중/반이중 모드를 전환할 필요가 생겼다.
- 동작 모드뿐만 아니라 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환하는 기능을 자동 조정(auto negotiation)이라고 한다.
- 이더넷은 데이터가 흐르고 있지 않을 때는 링크 펄스라는 펄스형의 신호를 흘려 상대가 올바르게 작동하는지, 케이블이 단선되지 않았는지 등을 확인한다.
- 나중에 특정 패턴으로 펄스 신호를 송신해 자신의 상황을 상대에게 전하는 방법이 고안되었는데, 자동 조정 기능은 이 방법을 이용한다.
- 이 패턴에 의해 지원 가능한 모드와 전송 속도를 서로 통지하고, 그 중에서 최적의 조합을 선택하여 각각 자기 자신을 설정한다.

### 스위칭 허브는 복수의 중계 동작을 동시에 실행한다
- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않아 비어있는 다른 포트에서 별도의 패킷을 흘릴 수 있다. 이렇게 동시에 여러 개의 패킷을 중계할 수 있다.
- 리피터 허브는 들어온 신호를 모든 포트에 뿌리므로 동시에 두 개 이상의 신호가 들어오면 패킷이 충돌해 복수의 신호를 동시에 흘릴 수 없다.
- 기기 전체에서 중계할 수 있는 패킷의 수는 스위칭 허브가 리피터 허브보다 많다.

## 라우터의 패킷 중계 동작
### 라우터의 기본
- 라우터의 중계의 원리는 스위칭 허브와 비슷하지만, 라우터의 바탕이 되는 것은 IP이고 스위칭 허브의 바탕이 되는 것은 이더넷이다.
- 라우터의 내부 구조는 패킷의 중계 대상을 판단하는 **중계 부분**과 패킷 송・수신을 담당하는 **포트 부분**으로 구성되어 있다.
- 라우터의 포트 부분에 통신 기술의 하드웨어를 장착하면 다양한 통신 기술을 지원할 수 있다.
- 라우터는 포트 부분의 통신 기술의 규칙에 따라 패킷을 수신하고, 중계 부분에서 받은 패킷의 중계 대상을 판한 후 중계 대상측의 포트로 패킷을 옮겨 포트 부분의 하드웨어 규칙에 따라 패킷 송신을 실행한다.
- 라우터의 각 포트에는 MAC 주소와 IP 주소가 할당되어 있다.
- 라우터와 스위칭 허브의 차이점은 스위칭 허브는 들어온 패킷을 전송하기만 하지만, 라우터는 자신이 송신처나 수신처가 된다는 것이다.

### 경로표에 등록된 정보
- 스위칭 허브는 MAC 주소로 중계 대상을 판단하지만, 라우터는 수신처 IP 주소로 중계 대상을 판단한다. (취급하는 주소가 다름)
- 라우터의 테이블은 라우팅 테이블 또는 경로표라고 부르며, 수신처, 넷마스크, 게이트웨이, 인터페이스, 매트릭 등의 정보를 등록한다.
- 수신처 항목에는 수신처의 정보가 들어있다. 수신처의 정보는 서브넷 자체를 나타내는 주소, 즉 네트워크 번호 부분의 비트에만 값이 있고, 호스트 번호 부분의 비트 값은 모두 0으로 되어 있는 IP 주소 정보가 있다.
- 라우터는 호스트 번호를 무시하고 네트워크 번호 부분만 조사해 패킷을 중계한다
- 넷마스크 항목은 경로표의 수신처와 패킷의 수신처 주소를 대조할 때 비트 수를 나타낸다.
- 게이트웨이 와 인터페이스는 패킷의 중계 대상을 나타낸다. 인터페이스(포트)에서 게이트웨이 항목에 등록되어 있는 IP 주소를 가진 라우터에 대해 패킷을 중계한다.
- 메트릭은 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼 지를 나타낸다. 수가 작으면 목적지가 가까운 것, 크면 먼 것을 나타낸다.
- 라우터는 경로표에 경로 정보를 등록하거나 갱신하는 동작이 패킷을 중계하는 동작과 분리되어 있다.
  - 사람이 수동으로 경로 정보를 등록/갱신
  - 라우팅 프로토콜(RIP, OSPF, BGP 등 복수의 프로토콜 존재)이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록
> 주소 집약: 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록

### 라우터의 패킷 수신 동작
- 라우터의 포트에는 MAC 주소가 할당되어 있으며, 라우터는 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않는 패킷을 폐기한다.

### 경로표를 검색하여 출력 포트를 발견한다
- 라우터에서 중계하는 패킷의 수신처 MAC 주소에는 라우터의 포트에 할당된 MAC 주소가 기록되어 있는데, 이는 MAC 헤더의 역할이 이 라우터에 패킷을 건네주는 것이기 때문이다. 라우터는 패킷 수신 후 MAC 헤더를 폐기한다.
- IP 헤더의 내용을 보고 패킷 중계 동작에 들어가는데, 중계 대상의 후보가 여러개일 경우 호스트 번호의 비트 수가 짧은 것을 선택한다. (서버가 속한 서브넷을 나타내는 주소보다 서버 자체를 나타내는 주소가 범위가 적다)
- 네트워크 번호의 길이가 같은 것이 여러 행 존재하는 경우도 있는데, 이는 라우터의 고장이나 케이블의 단선 등을 고려하여 우회로를 두는 경우에 해당한다. 이러한 경우에는 메트릭 값이 작은 쪽이 가까우므로 그 대상을 중계 대상으로 선택한다.
- 해당하는 행이 한 개도 발견되지 않는 경우는 패킷을 폐기하고, ICMP 메시지로 송신처에 이 사실을 통지한다. 라우터가 가정하는 네트워크, 즉 인터넷의 규모는 매우 크기 때문에 네트워크가 혼잡해지는 것을 막기 위해 중계 대상이 분명하지 않은 패킷을 폐기한다.

### 해당하는 경로가 없는 경우에 선택하는 기본 경로
- 라우터의 경로표에서 넷마스크 항목이 0.0.0.0인 행은 기본 경로를 나타내며, 여기에 등록한 라우터를 기본 게이트웨이라고 한다.

### 패킷은 유효 기한이 있다
- 경로표에서 중계 대상을 찾아내면 패킷을 출력측의 포트로 옮겨 송신하는데, 그 전에 TTL(Time To Live, 생존 기간)이라는 IP 헤더의 필드를 갱신해야 한다.
- TTL은 패킷의 생존기간을 나타내며, 라우터를 경유할 때마다 값이 1씩 줄어들다 0이 되면 생존 기간이 만료되는 것으로 간주되어 폐기된다.
- 이는 경로표에 등록된 정보의 오류나, 기기의 고장 등으로 우회로로 전환될때 일시적으로 경로가 혼란에 빠져 순환하는 사태를 막기 위함이다.

### 큰 패킷은 조각 나누기 기능으로 분할한다
- 라우터의 포트는 종류에 따라 패킷의 최대 길이가 달라지므로 출력 포트측의 패킷의 최대 길이가 입력측보다 작은 경우나, 패킷의 최대 길이는 같아도 여분으로 헤더를 부가해 패킷의 실질적 길이가 짧아지는 경우가 있다.
- 중계하는 패킷의 크기가 출력측의 패킷 최대 길이를 초과하면 그대로는 패킷을 송신할 수 없어 IP 프로토콜에 규정된 조각 나누기(fragmentation)라는 방법을 사용해 패킷을 분할하고, 패킷의 길이를 짧게 만든 후 중계한다.
- 출력측의 MTU(IP헤더 길이를 제외해 산출)를 조사하여 패킷을 그대로 출력측에서 송신할 수 있는지 조사하고, 출력측의 MTU가 작은 경우에는 여기에 저장할 수 있는 크기로 패킷을 분할한다.
- 이때 IP 헤더의 플래그 필드 값을 조사하여 필드가 분할 불가로 되어 있으면 패킷을 폐기하고 ICMP 메시지로 송신처에 통지하고, 그렇지 않으면 출력측의 MTU에 맞춰 데이터 부분을 맨 앞부분부터 차례대로 잘라낸다.
- TCP 헤더 이후의 부분이 분할 대상 데이터로 간주되는데 TCP 헤더는 IP 입장에서보면 데이터이기 때문이다.
- 분할한 데이터에 IP 헤더를 덧붙이는데 이때 원래 패킷의 IP 헤더를 그대로 복사하되 조각 나누기로 분할했다는 정보를 IP 헤더의 일부 필드에 기록한다.

### 라우터의 송신 동작은 컴퓨터와 같다
- 출력측의 포트에 따라 패킷의 송신 동작이 달라진다. (포트의 규칙에 따라 패킷 신호를 변환)
- 라우터가 다음에 건네줄 상대를 판단하는 방법
  - 경로표의 게이트웨이 항목에 IP 주소가 쓰여있으면 IP 주소가 건네줄 상대
  - 경로표의 게이트웨이 항목이 공란이면 IP 헤더의 수신처 IP 주소가 건네줄 상대
- 라우터도 ARP를 사용하여 다음에 건네줄 상대의 MAC 주소를 조사한다.
- 출력측의 포트가 이더넷이면 송신한 패킷은 스위칭 허브를 경유하여 다음 라우터에 도달하고, 그 라우터가 다시 그 담의 라우터에 패킷을 중계하는 식으로 패킷은 최종적으로 목적지에 도착한다.

### 라우터와 스위칭 허브의 관계
- 패킷을 중계할 때 맨 앞에 MAC 헤더를 부가한다 했으나, 사실 이더넷의 패킷 데이터 부분에 IP의 패킷을 넣어 이더넷의 원리로 다음 라우터까지 운반하는 것이 원래의 개념에 가깝다.
- IP라는 구조는 스스로 패킷을 운반하는 수단이 없어 이더넷에 의뢰하여 운반한다.
- 라우터는 IP의 개념에 기초하여 만들어졌고, 스위칭 허브는 이더넷에 기초하여 만들어졌기에 위 관계가 라우터와 스위칭 허브의 관계를 나타낸다.
- 실제 라우터에는 스위칭 허브를 내장한 기종이 있고, 가정에서 사용하는 인터넷 접속용 라우터는 유형이 많아 이 설명이 적당하지 않을 수도 있다.
- 통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고, 이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당한다.
- IP는 이런식으로 다음 라우터까지 스스로 패킷을 운반하지 않고 다양한 통신 기술에 의뢰하여 패킷을 운반할 수 있는데, 이 특징 덕분에 인터넷과 같은 거대한 네트워크를 만들 수 있다.

## 라우터의 부가 기능
### 주소 변환으로 IP 주소를 효율적으로 이용한다
- 라우터의 중요한 두 가지 기능으로는 **주소 변환**과 **패킷 필터링**이 있다.
- 주소 변환 기능은 주소 부족에 대처하기 위해 등장했다. 사내의 기기에 할당하는 주소는 다른 회사와 중복되어도 좋다고 해, 사내의 기기에는 고유 주소를 할당할 필요가 없어져 주소를 절약할 수 있다.
- 특정 주소를 사내용으로 사용한다는 규칙을 세우고, 이러한 규칙에 기초한 사내용 주소는 프라이비트 주소, 이전의 고유한 주소는 글로벌 주소로 부른다.
- 프라이비트 주소는 특별한 구조를 가지고 있는 것이 아니라 원래 글로벌 주소에 포함되어 있던 주소 중에서 범위를 정하고, 사내에서 사용한다고 약속한 것이다.
- 사내의 네트워크를 인터넷에 접속할 때는 사내의 네트워크를 인터넷에 공개하는 서버 접속 부분과 사내용 네트워크 두 가지로 나눈다.
- 공개용 서버쪽에는 글로벅 주소를 할당하고 인터넷과 직접 통신하고, 사내 네트워크에는 프라이비트 주소를 할당해 인터넷과 직접 패킷을 주고받지 않도록 특별한 구조를 사용하여 접속하는데, 이 구조가 주소 변환이다.

### 주소 변환의 기본 동작
- 주소 변환의 구조는 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔쓰는 것이다.
- TCP 접속 동작에서 최초로 흐르는 패킷을 인터넷에 중계할 때 송신처의 IP 주소를 프라이비트 주소에서 글로벌 주소로 바꿔 쓰고 이 데이터를 주소 변환 장치 내부에 있는 대응표에 기록해 둔다.
- 송신처의 IP 주소와 포트 번호를 바꿔쓴 후 패킷을 인터넷에 송출하고 서버에서 회신 패킷이 돌아오는데, 회신 패킷의 수신처는 글로번 주소와 포트 번호가 되어있고 이 주소는 주소 변환 장치에 할당되어 있어 주소 변환 장치로 되돌아온다.
- 주소 변환 장치는 대응표에서 프라이비트 주소와 포트 번호로 바꿔 패킷을 보내 송신처에 응답 패킷이 도착하고, 이 후 패킷을 주고받을 때는 대응표에서 주소의 대응 관계를 조사해 주소와 포트 번호를 바꿔쓰고 패킷을 중계한다.
- 데이터 송・수신을 끝내고 연결 끊기 동작의 패킷이 흐르다 인터넷에 대한 접속 동작이 끝나면 대응표에 등록한 것을 삭제한다.
- 인터넷측에서 보면 주소 변환장치(라우터)가 통신 상대로 되어있는 것으로 보인다.

### 포트 번호를 바꿔쓰는 이유
- 주소 변환을 주소만 바꿔 스면 프라이비트 주소와 글로번 주소가 1대1로 대응해 인터넷에 접속하는 대수만큼 글로벌 주소가 필요하다.
- 동시 접속 수가 늘어남에 따라, 포트 번호와 주소를 한 세트로 하여 프라이비트 주소에 대응시키게 되었는데, 이렇게 하면 한 개의 글로벌 주소를 수만 개의 프라이비트 주소에 대을시킬 수 있어 글로벌 주소의 이용 효율이 높아진다.

### 인터넷에서 회사로 액세스한다
- 인터넷에 액세스하지 않는 기기에는 인터넷측에서 패킷을 송신할 수 없다.
- 액세스중인 기기라해도 인터넷과의 통신에 사용하고 있는 포트 번호 이외의 포트에 패킷을 보낼 수 없다.
- 사내에서 의도적으로 인터넷에 액세스하지 않는 한 인터넷 측에서 사내에 패킷을 보낼 수 없고, 이는 부정 침입을 방지하는 효과를 가지고 있다.
- 공개용 서버는 주소 변환 장치의 밖으로 나가 글로벌 주소를 할당하지만, 서버의 프라이비트 주소를 주소 변환 장치에 수동으로 등록해 두면 사내에 있는 프라이비트 주소를 할당한 서버를 공개할 수도 있다.

### 라우터의 패킷 필터링 기능
- 패킷 필터링 기능은 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 그것이 사전에 설정한 조건에 합치되면 패킷을 중계하거나 폐기하는 것이다.
- 대부분의 방화벽이라는 기기나 소프트웨어는 이 원리를 이용하여 부정 침입을 방지한다.
